<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Programgarden JSON Runner</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/theme/elegant.css">
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      #editor { width: 100%; height: 500px; border: 1px solid #ddd; }
      .controls { margin-top: 10px; }
      .CodeMirror { height: 500px; }
      /* Key / value color tweaks */
      .CodeMirror .cm-key { color: #d73a49; font-weight: 600; }
      .CodeMirror .cm-string { color: #032f62; }
      .CodeMirror .cm-number { color: #005cc5; }
      .CodeMirror .cm-atom { color: #e36209; font-weight: 600; } /* True/False/None */
    </style>
  </head>
  <body>
    <h1>programgarden example</h1>
    <div id="editor"></div>

    <div class="controls">
      <button id="run">Run</button>
      <button id="stop">Stop</button>
      <span id="status">Idle</span>
    </div>

    <h3>Logs</h3>
    <div id="logs" style="height:200px; border:1px solid #ddd; padding:8px; overflow:auto; background:#f9f9f9;"></div>
    <div style="margin-top:6px;"><button id="clear-logs">Clear Logs</button></div>

    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/mode/python/python.js"></script>
    <script>
      // Initialize CodeMirror
      const textarea = document.createElement('textarea');
      textarea.id = 'python-editor';
      document.getElementById('editor').appendChild(textarea);
      const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'text/x-python',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        matchBrackets: true,
        theme: 'elegant'
      });

      // Overlay to highlight quoted keys (string followed by colon) as .cm-key
      const keyOverlay = {
        token: function(stream) {
          // try double-quoted key
          if (stream.match(/"([^"\\]|\\.)*"(?=\s*[:])/)) {
            return 'key';
          }
          // try single-quoted key
          if (stream.match(/'([^'\\]|\\.)*'(?=\s*[:])/)) {
            return 'key';
          }
          // advance one char
          stream.next();
          return null;
        }
      };
      editor.addOverlay(keyOverlay);

      function jsonToPythonLiteral(obj) {
        // Convert JSON object to pretty Python literal string
        // Use JSON stringify then replace true/false/null to Python equivalents
        const json = JSON.stringify(obj, null, 2);
        return json.replace(/\btrue\b/g, 'True').replace(/\bfalse\b/g, 'False').replace(/\bnull\b/g, 'None');
      }

      async function loadInitial() {
        try {
          const r = await fetch('/last_run_config');
          if (r.status === 200) {
            const data = await r.json();
            editor.setValue(jsonToPythonLiteral(data));
            return;
          }
        } catch (e) {
          // ignore and set default
        }
        const defaultJson = {"settings": {"name": "Example Condition"}, "securities": {}, "strategies": []};
        editor.setValue(jsonToPythonLiteral(defaultJson));
      }

      loadInitial();

      document.getElementById('run').addEventListener('click', async () => {
        try {
          const text = editor.getValue();
          document.getElementById('status').textContent = 'Starting...';
          // clear logs on new run
          await fetch('/logs/clear', { method: 'POST' });

          const res = await fetch('/run', {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: text
          });

          if (res.status === 202) {
            document.getElementById('status').textContent = 'Running';
            pollStatus();
          } else {
            const data = await res.json();
            document.getElementById('status').textContent = data.message || 'Error';
          }
        } catch (e) {
          document.getElementById('status').textContent = 'Invalid input';
        }
      });

      document.getElementById('stop').addEventListener('click', async () => {
        try {
          document.getElementById('status').textContent = 'Stopping...';
          const res = await fetch('/stop', { method: 'POST' });
          if (res.status === 202) {
            pollStatus();
          } else {
            const data = await res.json();
            document.getElementById('status').textContent = data.status || 'Error';
          }
        } catch (e) {
          document.getElementById('status').textContent = 'Error';
        }
      });

      let pollTimer = null;
      async function pollStatus() {
        if (pollTimer) return;
        pollTimer = setInterval(async () => {
          try {
            const s = await fetch('/status');
            const data = await s.json();
            document.getElementById('status').textContent = data.is_running ? 'Running' : 'Idle';
            if (!data.is_running) {
              clearInterval(pollTimer);
              pollTimer = null;
            }
          } catch (e) {
            console.error(e);
          }
        }, 800);
      }

      // Poll logs and display
      async function pollLogs() {
        try {
          const r = await fetch('/logs');
          const data = await r.json();
          const container = document.getElementById('logs');
          container.innerHTML = '';
          for (const line of data.logs) {
            const div = document.createElement('div');
            div.textContent = line;
            container.appendChild(div);
          }
          container.scrollTop = container.scrollHeight;
        } catch (e) {
          // ignore
        }
      }

        // Start polling logs every 3s (reduced to avoid frequent server access logs)
        setInterval(pollLogs, 3000);

      document.getElementById('clear-logs').addEventListener('click', async () => {
        await fetch('/logs/clear', { method: 'POST' });
        pollLogs();
      });
    </script>
  </body>
</html>
