
터틀 기반: 종목추출 → 신규매매 → 정정매매 → 취소매매 전략 문서
작성일: 2025-11-17
작성자: ChatGPT (요청자용 전략 템플릿)

목표
- 추세추종(Turtle-style) 원칙에 기반하여 종목 추출부터 주문 관리(신규/정정/취소)까지 운영 가능한 규칙을 정리.
- 자동화매매(오픈API)로 바로 구현 가능하도록 명확한 규칙과 주문 템플릿 제공.

1) 기본 정의 및 변수
- N: ATR 기반 변동성 지표 (Average True Range). 일별 N 계산(20일 지수평균 또는 단순평균 권장).
- RISK_PER_TRADE: 계좌자산 대비 1회 리스크 비율 (예: 0.01 = 1%).
- ACCOUNT_EQ: 계좌 총자산(원화, USD 등).
- UNIT: 포지션 단위(계산식 참고).
- ENTRY_LONG_PERIOD: 진입용 고점 기간 (기본 20).
- EXIT_LONG_PERIOD: 청산용 저점 기간 (기본 10).
- ENTRY_SHORT_PERIOD: 진입용 저점 기간 (기본 20).
- EXIT_SHORT_PERIOD: 청산용 고점 기간 (기본 10).
- MAX_UNITS_PER_INSTRUMENT: 하나 종목/상품 당 최대 유닛 수 (예: 4).
- MIN_TRADE_SIZE: 거래소 최소 거래 단위(수량/계약).

2) 종목추출 전략 (스캐닝)
목표: 추세가 발생할 가능성 높고, 유동성·슬리피지·수수료 고려해 선정.
- 스텝 A: 유동성 필터
  - 평균거래대금(20일) > threshold (예: 1,000만 원)
  - 평균거래량(20일) > threshold
- 스텝 B: 변동성 필터
  - N (20일 ATR) > 최소값(심사 필요)
- 스텝 C: 트렌드 필터 (진입 신호가 발생했거나 근접)
  - 현재가격이 20일 고가를 돌파했거나 (매수 후보)
  - 또는 55일 고가 돌파 (더 강한 신호)
- 스텝 D: 리스크 적합성
  - 포지션 산정 후 예상 레버리지/증거금/마진 요구치가 허용 범위 내일 것
- 스텝 E: 종목 배제 리스트
  - 공매도 제한 종목, 거래정지 임박, 권리락, 유상증자 등 이벤트 종목 제외

출력: 후보 종목 리스트(우선순위: 최근 고점 돌파일자 역순, ATR/평균거래대금 표기)

3) 신규매매 규칙 (Entry)
- 조건(롱):
  1. 종목이 스크리닝 통과
  2. 당일 종가(또는 실시간 가격)가 ENTRY_LONG_PERIOD(=20)일 고가를 돌파
  3. 포지션 사이징 계산으로 최소 거래수량 이상 확보 가능
  4. 이미 해당 종목에 MAX_UNITS_PER_INSTRUMENT 미만으로 보유 중이면 추가 허용
- 조건(숏): (선물/공매도 허용 종목)
  1. 당일 가격이 ENTRY_SHORT_PERIOD(=20)일 저가를 하향 돌파
  2. 나머지 조건 동일

- 포지션 사이징(예시)
  1) 1 Unit Risk = N * 계약 단위(또는 주당 변동가격)
  2) Dollars_at_risk = ACCOUNT_EQ * RISK_PER_TRADE
  3) UNIT = floor(Dollars_at_risk / (N * DollarPerPoint))
  4) 추가 제한: 최대 포지션 사이즈(계좌레버리지/마진 고려)
- 주문 유형: 시장가(Market) 또는 지정가(Limit)
  - 권장: 신규진입은 지정가(또는 제한적 슬리피지 허용 시장가)로 체결비용 최소화
- 예시 매수 주문 JSON
  {
    "symbol": "AAPL",
    "side": "BUY",
    "type": "LIMIT",
    "price": 150.00,
    "quantity": 100,
    "time_in_force": "GTC",
    "meta": {"strategy":"turtle","unit":1}
  }

4) 정정매매 (Modify Order) 규칙
- 목적: 지정가 미체결 시 가격 조정, 부분체결 관리, 포지션 사이징에 따른 보정
- 정정 트리거:
  1. 지정가 주문이 제출 후 X초/분(예: 30s/5min) 내 체결되지 않음
     - 정책 A: 유동성 낮음 → 지정가를 시장가 쪽으로 Y틱(또는 %) 이동 후 재지정(최대 Z번)
     - 정책 B: 급변장 → 주문 취소 후 재스캔(재평가)
  2. 부분체결(Partial Fill) 발생 시:
     - 남은 수량이 MIN_TRADE_SIZE보다 작으면 취소
     - 또는 남은 수량을 추가로 보완해 전체 목표 UNIT 맞춤
- 안전장치:
  - 정정 횟수 제한(예: 주문당 최대 3회 정정)
  - 정정 시 누적 슬리피지/수수료 추적
- 정정 주문 예시(체결되지 않아 가격 상향)
  {
    "orig_order_id": "abc123",
    "new_price": 150.50,
    "new_quantity": 100
  }

5) 취소매매 (Cancel Order) 규칙
- 즉시 취소 상황:
  1. 주문 제출 후 지정된 시간(예: 5분) 내 미체결 → 자동 취소(모니터링 필요)
  2. 시장의 급변(예: 시세가 기준 가격 대비 ±X% 이상 변동) 발생 시 모든 미체결 지정가 취소
  3. 종목 이벤트(호가창 이상징후, 거래정지 알림) 발생 시 즉시 취소
- 부분 체결 후 취소 정책:
  - 남은 수량이 MIN_TRADE_SIZE보다 작으면 취소
  - 또는 남은 수량으로 인해 리스크 규정(RISK_PER_TRADE) 위반 시 취소
- 취소 로깅: 모든 취소는 이유(시간, 계좌 상태, 이벤트)를 로그에 남김

6) 손절(Exit) / 청산 규칙
- 기본 청산:
  - Long: 가격이 EXIT_LONG_PERIOD(=10)일 저가를 하향 돌파 → 전부 청산 또는 일부 청산(피라미딩 단위별)
  - Short: 가격이 EXIT_SHORT_PERIOD(=10)일 고가 상향 돌파 → 청산
- 트레일링 방식:
  - ATR 기반 트레일링: 최근 최고가에서 k*N 떨어진 지점(예: 2*N)으로 스탑 업데이트
- 부분 청산(리스크 관리):
  - 포지션이 2단계 이상 수익 구간에 있을 경우 일부(예: 첫 유닛 50%) 이익실현
- 예외: 극단적 슬리피지/유동성 붕괴 시 시장가 청산 허용

7) 포지션 관리 및 피라미딩(추가진입)
- 피라미딩 조건:
  1. 최초 유닛 진입 후 가격이 유리하게 흘러 N*X(예: 0.5~1*N)만큼 움직였을 때 추가 유닛 진입
  2. 총 유닛 수는 MAX_UNITS_PER_INSTRUMENT로 제한
- 동시 보유 종목 수 관리:
  - 포트폴리오 레벨의 최대 노출(예: 총 계좌 자산 대비 50% 최대 위험)
- 리밸런싱:
  - 일별/주별 포지션 점검. 마진 요구 변화나 이벤트에 따라 자동 축소

8) 예외 및 보호 메커니즘
- Circuit Breaker: 계좌손실이 일정 비율(예: 10%)을 초과하면 모든 신규진입 중지 및 트레일링 스탑으로 기존 포지션만 관리
- Max Drawdown Stop: 일간 손실 한도 도달 시 전체 전략 정지
- 이벤트 모니터: 공시/배당/옵션만기/거래정지 알림 연동
- 연결 실패 시 안전 모드: 중개사 API 장애시 모든 미체결 주문 취소 및 포지션 유지(또는 즉시 청산, 정책 선택)

9) 로그 및 리포트
- 주문 로그: 주문ID, 시간, 심볼, 사이드, 가격, 수량, 상태(신규/부분체결/체결/정정/취소), 체결 평균가
- 성과 리포트: 일별/주별/월별 P&L, 최대낙폭, 승률, 평균 이익/손실, 샤프비율 등
- 컴플라이언스 로그: 규칙 위반 시 관리자 알림

10) 구현 팁(오픈API 연동)
- 주문 전 최신 계좌/잔고/증거금 정보 fetch
- 지정가/시장가 선택 로직: 유동성 낮은 종목엔 스플릿 주문(작게 여러번) 적용
- 타임아웃/재시도 로직(네트워크 오류 대비)
- 테스트 모드(페이퍼 트레이드)로 장기간 백테스트 후 실전 전환

11) 주문 처리 예시 흐름(의사코드)
- 종목 스캔 → 후보 리스트 생성
- 후보별 진입 체크(20일 돌파?) → 포지션 크기 계산
- 주문 생성(지정가) → 모니터링(체결/미체결)
  - 미체결 → 정정 정책 적용(횟수 제한)
  - 부분체결 → 잔량 관리(취소/보완)
- 체결 시 스톱(손절) 주문 등록(브로커 지원 시 OCO)
- 포지션마다 트레일링 스탑 업데이트
- 청산 조건 충족 시 청산 주문 전송

12) 실전 파라미터(권장 시작값, 튜닝 필수)
- ENTRY_LONG_PERIOD = 20
- EXIT_LONG_PERIOD = 10
- ENTRY_LONG_STRONG = 55
- RISK_PER_TRADE = 0.01 (1%)
- MAX_UNITS_PER_INSTRUMENT = 4
- ATR 기간 = 20
- 정정 최대 횟수 = 3
- 지정가 미체결 타임아웃 = 300초(5분)

13) 주의사항(리스크 고지)
- 어떤 전략도 과거 성과가 미래수익을 보장하지 않음.
- 슬리피지, 수수료, 세금, 레버리지 위험 존재.
- 실전 적용 전 충분한 백테스트와 페이퍼트레이드 권장.

부록: 주문 JSON 템플릿, 로그 예제, 유틸티 계산식(단위 변환, ATR 계산법) 포함.

